---
- hosts: ivre
  tasks:
  # https://github.com/cea-sec/ivre/blob/master/doc/FAST-INSTALL-AND-FIRST-RUN.md
  - name: Install IVRE dependencies
    apt:
      update_cache: yes
      name: "{{ item }}"
      state: latest
    with_items:
      - 'git'
      - 'mongodb'
      - 'python-pymongo'
      - 'python-crypto'
      - 'apache2'
      - 'dokuwiki'
      - 'python-pip'
      - 'python3-pip'
      - 'zmap'
      - 'p0f'

  - name: nmap 7.60
    shell: |
      nmap=nmap.bz2
      wget -O $nmap https://nmap.org/dist/nmap-7.60.tar.bz2
      bzip2 -cd $nmap | tar xvf -
      cd nmap-7.60
      ./configure
      make
      make install
      ln -s /usr/local/bin/nmap /usr/bin/nmap

  - name: Bro - IVRE dependencies
    shell: echo 'deb http://download.opensuse.org/repositories/network:/bro/xUbuntu_16.04/ /' > /etc/apt/sources.list.d/bro.list


  - name: Bro - IVRE dependencies
    shell: wget -q -O - http://download.opensuse.org/repositories/network:bro/xUbuntu_16.04/Release.key | apt-key add -

  - name: Bro - IVRE dependencies
    apt:
      update_cache: yes
      name: bro
      state: latest

  - name: Neo4j apt key - IVRE dependencies
    apt_key:
      url: https://debian.neo4j.org/neotechnology.gpg.key
      state: present
  - name: neo4j repo
    shell: echo 'deb https://debian.neo4j.org/repo stable/' > /etc/apt/sources.list.d/neo4j.list
  - name: Install neo4j - IVRE dependencies
    apt:
      update_cache: yes
      name: neo4j
      state: latest

  - name: tesseract-ocr - IVRE dependencies
    apt:
      name: tesseract-ocr
      state: latest

  - name: Install IVRE python dependencies
    pip:
      name: "{{ item }}"
      state: latest
    with_items:
      - 'pymongo>=2.7.2'
      - 'py2neo>=3'
      - 'pycrypto'
      - 'sqlalchemy'
      - 'psycopg2'
      - 'future'
  - name: Install mongo python dependencies
    pip:
      name: "{{ item }}"
      state: latest
    with_items:
      - 'pymongo>=2.7.2'
      - 'pycrypto'
      - 'future'
  - name: Install neo4j python dependencies
    pip:
      name: "{{ item }}"
      state: latest
    with_items:
      - 'py2neo>=3'
      - 'pycrypto'
      - 'future'
  - name: Install postgres python dependencies
    pip:
      name: "{{ item }}"
      state: latest
    with_items:
      - 'pycrypto'
      - 'sqlalchemy'
      - 'psycopg2'
      - 'future'


  - name: dokuwiki conf
    debconf:
      name: dokuwiki
      question: dokuwiki/wiki/password
      vtype: password
      value: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          30393139393862323036393731303139626261303266333831656530373363626364333933663132
          3239633537663632643932656332643564383531373535640a323565636362363336616262613234
          65333666616333323733343533366461623161663065353932346233386464326238383062303363
          3039636634366664660a313130653334383633616130613965643661623863373936303664336538
          3936

  - debconf:
      name: dokuwiki
      question: dokuwiki/wiki/confirm
      vtype: password
      value: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          30393139393862323036393731303139626261303266333831656530373363626364333933663132
          3239633537663632643932656332643564383531373535640a323565636362363336616262613234
          65333666616333323733343533366461623161663065353932346233386464326238383062303363
          3039636634366664660a313130653334383633616130613965643661623863373936303664336538
          3936

  - debconf:
      name: dokuwiki
      question: dokuwiki/system/purgepages
      vtype: boolean
      value: false

  - shell: |
      cat > /etc/apache2/conf-available/dokuwiki.conf <<EOF
      AliasMatch ^/dokuwiki/sites/[^/]+$      /usr/share/dokuwiki/
      AliasMatch ^/dokuwiki/sites/[^/]+/(.*)$ /usr/share/dokuwiki/$1
      Alias      /dokuwiki                    /usr/share/dokuwiki/

      <Directory /usr/share/dokuwiki/>
      Options +FollowSymLinks
      AllowOverride All
      order allow,deny
              Allow from localhost 127.0.0.1 ::1
              Allow from all


              <IfModule mod_rewrite.c>

                      # Uncomment to implement server-side URL rewriting
                      # (cf. <http://www.dokuwiki.org/config:userewrite>).
                              # Do *not* mix that with multisite!
                      RewriteEngine on
                      RewriteBase /dokuwiki
                      RewriteRule ^lib                      - [L]
                      RewriteRule ^doku.php                 - [L]
                      RewriteRule ^feed.php                 - [L]
                      RewriteRule ^_media/(.*)              lib/exe/fetch.php?media=$1  [QSA,L]
                      RewriteRule ^_detail/(.*)             lib/exe/detail.php?media=$1 [QSA,L]
                      RewriteRule ^_export/([^/]+)/(.*)     doku.php?do=export_$1&id=$2 [QSA,L]
                      RewriteRule ^$                        doku.php  [L]
                      RewriteRule (.*)                      doku.php?id=$1  [QSA,L]
              </IfModule>
      </Directory>

      <Directory /usr/share/dokuwiki/bin>
              Require all denied
      </Directory>

      <Directory /var/lib/dokuwiki/data>
              Require all denied
      </Directory>


  - name: Update pip
    pip:
      name: pip
      state: latest

  - name: Clone ivre
    git:
      repo: 'https://github.com/cea-sec/ivre'
      dest: /root/ivre
      update: yes
      clone: yes

  - name: cd ivre
    shell: |
      cd ivre
      chmod +x setup.py

  - name: setup.py build
    command: ./setup.py build
    args:
      chdir: /root/ivre

  - name: setup.py install
    command: ./setup.py install
    args:
      chdir: /root/ivre

  - name: ivre setup
    shell: |
      cd /var/www/html ## or depending on your version /var/www
      rm index.html
      ln -s /usr/local/share/ivre/web/static/* .
      cd /usr/lib/cgi-bin
      ln -s /usr/local/share/ivre/web/cgi-bin/* .
      cd /var/lib/dokuwiki/data/pages
      ln -s /usr/local/share/ivre/dokuwiki/doc
      cd /var/lib/dokuwiki/data/media
      ln -s /usr/local/share/ivre/dokuwiki/media/logo.png
      ln -s /usr/local/share/ivre/dokuwiki/media/doc
      cd /usr/share/dokuwiki
      patch -f -p0 < /usr/local/share/ivre/dokuwiki/backlinks.patch
      cd /etc/apache2/mods-enabled
      for m in cgi rewrite ; do [ -L $m.load ] || ln -s ../mods-available/$m.load ; done
      cd /usr/local/share/ivre/web/cgi-bin
      sed -i 's/^\(\s*\)#Rewrite/\1Rewrite/' /etc/dokuwiki/apache.conf
      service apache2 reload

  - name: Database init, data download & importation
    shell: |
      ivre scancli --init < /dev/null
      ivre ipinfo --init < /dev/null
      ivre ipdata --init < /dev/null
      sudo ivre runscansagentdb --init < /dev/null
#      sudo ivre ipdata --download
#      ivre ipdata --import-all --no-update-passive-db

  - name: Getting IP data
    shell: |
      ivre ipdata --download
      ivre ipdata --import-all --no-update-passive-db

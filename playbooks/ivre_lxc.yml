---
- hosts: ivre
  tasks:
  # https://github.com/cea-sec/ivre/blob/master/doc/FAST-INSTALL-AND-FIRST-RUN.md
  - name: Install IVRE dependencies
    apt:
      update_cache: yes
      name: "{{ item }}"
      state: latest
    with_items:
      - 'git'
      - 'mongodb'
      - 'python-pymongo'
      - 'python-crypto'
      - 'apache2'
      - 'dokuwiki'
      - 'python-pip'
      - 'python3-pip'
      - 'nmap'
      - 'zmap'

  - name: Bro - IVRE dependencies
    shell: echo 'deb http://download.opensuse.org/repositories/network:/bro/xUbuntu_16.04/ /' > /etc/apt/sources.list.d/bro.list


  - name: Bro - IVRE dependencies
    shell: wget -q -O - http://download.opensuse.org/repositories/network:bro/xUbuntu_16.04/Release.key | apt-key add -

  - name: Bro - IVRE dependencies
    apt:
      update_cache: yes
      name: bro
      state: latest

  - name: Neo4j apt key - IVRE dependencies
    apt_key:
      url: https://debian.neo4j.org/neotechnology.gpg.key
      state: present
  - name: neo4j repo
    shell: echo 'deb https://debian.neo4j.org/repo stable/' > /etc/apt/sources.list.d/neo4j.list
  - name: Install neo4j - IVRE dependencies
    apt:
      update_cache: yes
      name: neo4j
      state: latest

  - name: tesseract-ocr - IVRE dependencies
    apt:
      name: tesseract-ocr
      state: latest

  - name: Install IVRE python dependencies
    pip:
      name: "{{ item }}"
      state: latest
    with_items:
      - 'pymongo>=2.7.2'
      - 'py2neo>=3'
      - 'pycrypto'
      - 'sqlalchemy'
      - 'psycopg2'
      - 'future'
  - name: Install mongo python dependencies
    pip:
      name: "{{ item }}"
      state: latest
    with_items:
      - 'pymongo>=2.7.2'
      - 'pycrypto'
      - 'future'
  - name: Install neo4j python dependencies
    pip:
      name: "{{ item }}"
      state: latest
    with_items:
      - 'py2neo>=3'
      - 'pycrypto'
      - 'future'
  - name: Install postgres python dependencies
    pip:
      name: "{{ item }}"
      state: latest
    with_items:
      - 'pycrypto'
      - 'sqlalchemy'
      - 'psycopg2'
      - 'future'


  - name: dokuwiki conf
    debconf:
      name: dokuwiki
      question: dokuwiki/wiki/password
      vtype: password
      # change to ansible-vault
      value: xthmuZKGiWBQA6Cp8X2R
    debconf:
      name: dokuwiki
      question: dokuwiki/wiki/confirm
      vtype: password
      # change to ansible-vault
      value: xthmuZKGiWBQA6Cp8X2R
    debconf:
      name: dokuwiki
      question: dokuwiki/system/purgepages
      vtype: boolean
      value: false

  - name: Update pip
    pip:
      name: pip
      state: latest

  - name: Clone ivre
    git:
      repo: 'https://github.com/cea-sec/ivre'
      dest: /root/ivre
      update: yes
      clone: yes

  - name: cd ivre
    shell: |
      cd ivre
      chmod +x setup.py

  - name: setup.py build
    command: ./setup.py build
    args:
      chdir: /root/ivre

  - name: setup.py install
    command: ./setup.py install
    args:
      chdir: /root/ivre

  - name: ivre setup
    shell: |
      cd /var/www/html ## or depending on your version /var/www
      rm index.html
      ln -s /usr/local/share/ivre/web/static/* .
      cd /usr/lib/cgi-bin
      ln -s /usr/local/share/ivre/web/cgi-bin/* .
      cd /var/lib/dokuwiki/data/pages
      ln -s /usr/local/share/ivre/dokuwiki/doc
      cd /var/lib/dokuwiki/data/media
      ln -s /usr/local/share/ivre/dokuwiki/media/logo.png
      ln -s /usr/local/share/ivre/dokuwiki/media/doc
      cd /usr/share/dokuwiki
      patch -f -p0 < /usr/local/share/ivre/dokuwiki/backlinks.patch
      cd /etc/apache2/mods-enabled
      for m in cgi rewrite ; do [ -L $m.load ] || ln -s ../mods-available/$m.load ; done
      cd /usr/local/share/ivre/web/cgi-bin
      sed -i 's/^\(\s*\)#Rewrite/\1Rewrite/' /etc/dokuwiki/apache.conf
      service apache2 reload

  - name: Database init, data download & importation
    shell: |
      ivre scancli --init < /dev/null
      ivre ipinfo --init < /dev/null
      ivre ipdata --init < /dev/null
      sudo ivre runscansagentdb --init < /dev/null
#      sudo ivre ipdata --download
#      ivre ipdata --import-all --no-update-passive-db

  - name: Getting IP data
    shell: |
      ivre ipdata --download
      ivre ipdata --import-all --no-update-passive-db

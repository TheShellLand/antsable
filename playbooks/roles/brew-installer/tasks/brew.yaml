---
- block:
    - name: "{{ BREW }} install --cask {{ package }}"
      shell: "{{ BREW }} install --cask {{ package }}"
      register: shell
      changed_when:
        - "'installed' not in shell.stderr"
        - '"there is already an App" not in shell.stderr'
      failed_when:
        - '"there is already an App" not in shell.stderr'

    - name: "{{ BREW }} upgrade --cask {{ package }}"
      shell: "{{ BREW }} upgrade --cask {{ package }}"
      register: shell
      failed_when: shell.stdout
      changed_when: shell.stdout
      when: "'installed' in shell.stderr"

  rescue:
    - name: "{{ BREW }} install {{ package }}"
      shell: "{{ BREW }} install {{ package }}"
      register: shell
      changed_when: "'installed' not in shell.stderr"

    - name: "{{ BREW }} upgrade {{ package }}"
      shell: "{{ BREW }} upgrade {{ package }}"
      register: shell
      failed_when: shell.stdout
      changed_when: shell.stdout
      when: "'installed' in shell.stderr"

    - name: "{{ BREW }} link {{ package }}"
      shell: "{{ BREW }} link {{ package }}"
      register: shell
      changed_when: "'installed' not in shell.stderr"
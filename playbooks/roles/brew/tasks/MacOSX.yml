---
- block:
    - name: "{{ BREW }} --version"
      shell: "{{ BREW }} --version"
      register: shell
      changed_when: false

    - name: "current user must have ownership {{ lookup('env', 'USER') }}"
      shell: | 
        chown -R $(whoami) /usr/local/Homebrew
        #chown -R $(whoami) /usr/local/share/aclocal /usr/local/share/locale /usr/local/share/man/man3 /usr/local/share/man/man7 /usr/local/share/zsh /usr/local/share/zsh/site-functions /usr/local/var/homebrew/locks
        #chmod u+w /usr/local/Homebrew /usr/local/share/aclocal /usr/local/share/locale /usr/local/share/man/man3 /usr/local/share/man/man7 /usr/local/share/zsh /usr/local/share/zsh/site-functions /usr/local/var/homebrew/locks
        echo OK
      become: yes
      become_user: "{{ lookup('env', 'USER') }}"
      register: shell
      changed_when: "'OK' not in shell.stdout"

  rescue:

    - name: '{{ ARCH }} /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"'
      shell: '{{ ARCH }} /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"'
      register: shell
      changed_when: "shell.rc != 0"
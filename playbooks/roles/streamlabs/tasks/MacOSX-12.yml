---
- block:
  - name: install
    shell: |
      {{ BREW_M1 }} install --cask {{ package }}
    register: shell
    changed_when: "'installed' not in shell.stderr"

  - name: upgrade
    shell: |
      {{ BREW_M1 }} upgrade --cask {{ package }}
    register: shell
    failed_when: shell.stdout
    changed_when: shell.stdout
    when: "'installed' in shell.stderr"
  when: BREW_INSTALL


- set_fact:
    url: https://slobs-cdn.streamlabs.com/Streamlabs+Desktop-1.6.1.dmg
    file: streamlabs.dmg
    folder: Streamlabs Desktop 1.6.1
    app: Streamlabs Desktop.app

- get_url:
    url: "{{url}}"
    dest: "./{{file}}"

- shell: |
    yes | hdiutil attach -nobrowse {{file}}
    rsync -arui "/Volumes/{{ folder }}/{{ app }}" /Applications/ && echo OK
    hdiutil detach '/Volumes/{{folder}}'
  register: shell
#  become: yes
  changed_when: "'OK' not in shell.stdout"
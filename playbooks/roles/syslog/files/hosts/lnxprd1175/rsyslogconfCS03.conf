#### NCCS03 ####

# Load statistics counter. Must come first
module(load="impstats" Ruleset="rsyslog_pstats" ResetCounters="on")

#### MODULES ####

# The imjournal module bellow is now used as a message source instead of imuxsock.
$ModLoad imuxsock # provides support for local system logging (e.g. via logger command)
$ModLoad imjournal # provides access to the systemd journal
$MaxMessageSize 16k
$ModLoad imudp
$ModLoad imtcp
$IMJournalRatelimitInterval 10
$IMJournalRatelimitBurst 50000
$DefaultNetstreamDriver gtls

#Certificates for TLS
$DefaultNetstreamDriverCAFile /etc/rsyslog.d/certs/ca_public_cert.pem
$DefaultNetstreamDriverCertFile /etc/rsyslog.d/certs/logging_vip_cert.pem
$DefaultNetstreamDriverKeyFile /etc/rsyslog.d/certs/logging_vip_private_key.pem

#### GLOBAL DIRECTIVES ####

# Where to place auxiliary files
$WorkDirectory /var/lib/rsyslog

$ActionFileDefaultTemplate RSYSLOG_SyslogProtocol23Format

# Turn off message reception via local log socket;
# local messages are retrieved through imjournal now.
$OmitLocalLogging on

# File to store the position in the journal
$IMJournalStateFile imjournal.state

# Templates - For that uber logging :-p
#$template JustJoshin,"%TIMESTAMP% %HOSTNAME% %syslogtag%%msg%\n"
$template fixit,"%TIMESTAMP% %HOSTNAME% %syslogtag%%msg%\n"
$template impervafixit, "%rawmsg-after-pri%\n"

# impstats output
$template rsyslog_pstats_file,"/opt/syslog/rsyslog/impstats/%HOSTNAME%.log"

# Splunk Sourcetyping Template subsection
$template password_tools,"/opt/syslog/password_tools/pwdtools/%HOSTNAME%.log"
$template checkpoint_syslog,"/opt/syslog/firewall/checkpoint/%FROMHOST%.log"
$template customapps_syslog,"/opt/syslog/customapps/fosse_spasoft/%HOSTNAME%.log"
$template aruba_syslog,"/opt/syslog/netdev/aruba/%HOSTNAME%.log"
$template dhcp_syslog,"/opt/syslog/dhcp/ipcontrol/%HOSTNAME%.log"
$template database_syslog,"/opt/syslog/database/imperva/%HOSTNAME%.log"
$template ironport_syslog,"/opt/syslog/mail/ironport/%HOSTNAME%.log"
$template ciscoISE_syslog,"/opt/syslog/netdev/ciscoISE/%HOSTNAME%.log"
$template reflector_syslog,"/opt/syslog/netdev/reflector/%HOSTNAME%.log"
$template pan_syslog,"/opt/syslog/firewall/paloalto/%HOSTNAME%.log"

#### RULES ####
# Log all kernel messages to the console.
# Logging much else clutters up the screen.
$RuleSet local
#kern.* /dev/console
# Log anything (except mail) of level info or higher.
# Don't log private authentication messages!
*.info;mail.none;authpriv.none;cron.none /var/log/messages
# The authpriv file has restricted access.
authpriv.* /var/log/secure
# Log all the mail messages in one place.
mail.* -/var/log/maillog
# Log cron stuff
cron.* /var/log/cron
# Everybody gets emergency messages
*.emerg :omusrmsg:*
# Save news errors of level crit and higher in a special file.
uucp,news.crit /var/log/spooler
# Save boot messages also to boot.log
local7.* /var/log/boot.log
$DefaultRuleset local

$RuleSet CR_FW_IDS_TCP_TLS_5085
$InputTCPServerStreamDriverAuthMode x509/name
$InputTCPServerStreamDriverPermittedPeer *.marriott.com
$InputTCPServerStreamDriverPermittedPeer *.starwoodhotels.com
$InputTCPServerStreamDriverPermittedPeer *.star
$InputTCPServerStreamDriverPermittedPeer sinlcppas05
$InputTCPServerStreamDriverPermittedPeer sinlcppas05.apac.star
$InputTCPServerStreamDriverMode 1
*.* |/var/log/CR_FW_IDS_TCP_TLS_5085.log;fixit
#*.* @@162.130.112.9:5015;JustJoshin

$RuleSet checkpoint_fw
$InputTCPServerStreamDriverMode 0
:fromhost, startswith, "hdqncvmsanesp" ~
*.* ?checkpoint_syslog;fixit

$RuleSet pwdtools
$InputTCPServerStreamDriverMode 0
:fromhost, startswith, "hdqncvmsanesp" ~
*.* ?password_tools;fixit

$RuleSet dhcp
$InputTCPServerStreamDriverMode 0
:fromhost, startswith, "hdqncvmsanesp" ~
*.* ?dhcp_syslog;RSYSLOG_TraditionalFileFormat

$RuleSet customapps
$InputTCPServerStreamDriverMode 0
:fromhost, startswith, "hdqncvmsanesp" ~
*.* ?customapps_syslog;fixit

$RuleSet aruba
$InputTCPServerStreamDriverMode 0
:fromhost, startswith, "hdqncvmsanesp" ~
*.* ?aruba_syslog;fixit

$RuleSet database
$InputTCPServerStreamDriverMode 0
:fromhost, startswith, "hdqncvmsanesp" ~
*.* ?database_syslog;impervafixit

$RuleSet ironport
$InputTCPServerStreamDriverMode 0
:fromhost, startswith, "hdqncvmsanesp" ~
*.* ?ironport_syslog;fixit

$RuleSet rsyslog_pstats
*.* ?rsyslog_pstats_file;RSYSLOG_SyslogProtocol23Format

$RuleSet ciscoISE
$InputTCPServerStreamDriverMode 0
*.* ?ciscoISE_syslog;fixit

$RuleSet reflector
$InputTCPServerStreamDriverMode 0
*.* ?reflector_syslog;fixit

$RuleSet pan
$InputTCPServerStreamDriverMode 0
#*.* ?pan_syslog;fixit
*.* ~

$InputTCPServerBindRuleset CR_FW_IDS_TCP_TLS_5085
$InputTCPServerRun 5085
$InputTCPServerBindRuleset checkpoint_fw
$InputTCPServerRun 5095
$InputTCPServerBindRuleset pwdtools
$InputTCPServerRun 5020
$InputTCPServerBindRuleset dhcp
$InputTCPServerRun 5105
$InputTCPServerBindRuleset customapps
$InputTCPServerRun 5015
$InputUDPServerBindRuleset aruba
$UDPServerRun 5045
$InputTCPServerBindRuleset database
$InputTCPServerRun 5115
$InputTCPServerBindRuleset ironport
$InputTCPServerRun 5120
$InputTCPServerBindRuleset ciscoISE
$InputTCPServerRun 5130
$InputUDPServerBindRuleset reflector
$UDPServerRun 5130
$InputTCPServerBindRuleset pan
$InputTCPServerRun 5140

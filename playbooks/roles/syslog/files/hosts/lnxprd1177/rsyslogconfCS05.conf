#### NCCS05 ####

# Load statistics counter. Must come first
module(load="impstats" Ruleset="rsyslog_pstats" ResetCounters="on")

#### MODULES ####

# The imjournal module bellow is now used as a message source instead of imuxsock.
$ModLoad imuxsock # provides support for local system logging (e.g. via logger command)
$ModLoad imjournal # provides access to the systemd journal
$MaxMessageSize 16k
$ModLoad imudp
$ModLoad imtcp
$IMJournalRatelimitInterval 10
$IMJournalRatelimitBurst 50000
$DefaultNetstreamDriver gtls

#Certificates for TLS
$DefaultNetstreamDriverCAFile /etc/rsyslog.d/certs/ca_public_cert.pem
$DefaultNetstreamDriverCertFile /etc/rsyslog.d/certs/logging_vip_cert.pem
$DefaultNetstreamDriverKeyFile /etc/rsyslog.d/certs/logging_vip_private_key.pem

#### GLOBAL DIRECTIVES ####

# Where to place auxiliary files
$WorkDirectory /var/lib/rsyslog

$ActionFileDefaultTemplate RSYSLOG_SyslogProtocol23Format

# Turn off message reception via local log socket;
# local messages are retrieved through imjournal now.
$OmitLocalLogging on

# File to store the position in the journal
$IMJournalStateFile imjournal.state

# Templates - For that uber logging :-p
#$template JustJoshin,"%TIMESTAMP% %HOSTNAME% %syslogtag%%msg%\n"
$template fixit,"%TIMESTAMP% %HOSTNAME% %syslogtag%%msg%\n"

# impstats output
$template rsyslog_pstats_file,"/opt/syslog/rsyslog/impstats/%HOSTNAME%.log"

# Splunk Sourcetyping Template subsection
$template checkpoint_syslog,"/opt/syslog/firewall/checkpoint/%FROMHOST%.log"
$template customapps_syslog,"/opt/syslog/customapps/fosse_spasoft/%HOSTNAME%.log"
$template ironport_syslog,"/opt/syslog/mail/ironport/%HOSTNAME%.log"
$template netdev_syslog,"/opt/syslog/netdev/networkdevices/%HOSTNAME%.log"
$template ACLprop,"/opt/syslog/netdev/propertyACL/%HOSTNAME%.log"
$template ciscoASA,"/opt/syslog/netdev/ciscoASA/%HOSTNAME%.log"
$template mi_connector,"/opt/syslog/netdev/mi_connector/%HOSTNAME%.log"
$template trend_epp,"/opt/syslog/endpoint/trend/%HOSTNAME%.log"
$template snort_syslog,"/opt/syslog/ids/snort/%HOSTNAME%.log"
$template ciscoISE_syslog,"/opt/syslog/netdev/ciscoISE/%HOSTNAME%.log"
$template reflector_syslog,"/opt/syslog/netdev/reflector/%HOSTNAME%.log"
$template pan_syslog,"/opt/syslog/firewall/paloalto/%HOSTNAME%.log"

#### RULES ####
# Log all kernel messages to the console.
# Logging much else clutters up the screen.
$RuleSet local
#kern.* /dev/console
# Log anything (except mail) of level info or higher.
# Don't log private authentication messages!
*.info;mail.none;authpriv.none;cron.none /var/log/messages
# The authpriv file has restricted access.
authpriv.* /var/log/secure
# Log all the mail messages in one place.
mail.* -/var/log/maillog
# Log cron stuff
cron.* /var/log/cron
# Everybody gets emergency messages
*.emerg :omusrmsg:*
# Save news errors of level crit and higher in a special file.
uucp,news.crit /var/log/spooler
# Save boot messages also to boot.log
local7.* /var/log/boot.log
$DefaultRuleset local

$RuleSet CR_XnixSecLog_TCP_TLS_5090
$InputTCPServerStreamDriverAuthMode x509/name
$InputTCPServerStreamDriverPermittedPeer *.marriott.com
$InputTCPServerStreamDriverPermittedPeer *.starwoodhotels.com
$InputTCPServerStreamDriverPermittedPeer *.stc.star
$InputTCPServerStreamDriverPermittedPeer sinlcppas05
$InputTCPServerStreamDriverPermittedPeer sinlcppas05.apac.star
$InputTCPServerStreamDriverMode 1
*.* |/var/log/CR_XnixSecLog_TCP_TLS_5090.log;fixit

$RuleSet checkpoint_fw
$InputTCPServerStreamDriverMode 0
:fromhost, startswith, "hdqncvmsanesp" ~
*.* ?checkpoint_syslog;fixit

$RuleSet trend
$InputTCPServerStreamDriverMode 0
:fromhost, startswith, "hdqncvmsanesp" ~
*.* ?trend_epp;fixit

$RuleSet netdev
$InputTCPServerStreamDriverMode 0
#*.* ?netdevsyslog;fixit
:msg, contains, "-6-IPACCESSLOGP" ?ACLprop;fixit
&~
:rawmsg, contains, "%ASA-" ?ciscoASA;fixit
&~
:msg, regex, "ipsecd \[[0-9]*\]" ?mi_connector;fixit
&~
*.* ?netdev_syslog;fixit

$RuleSet customapps
$InputTCPServerStreamDriverMode 0
:fromhost, startswith, "hdqncvmsanesp" ~
*.* ?customapps_syslog;fixit

$RuleSet snort
$InputTCPServerStreamDriverMode 0
:fromhost, startswith, "hdqncvmsanesp" ~
*.* ?snort_syslog;fixit

$RuleSet ironport
$InputTCPServerStreamDriverMode 0
:fromhost, startswith, "hdqncvmsanesp" ~
*.* ?ironport_syslog;fixit

$RuleSet rsyslog_pstats
*.* ?rsyslog_pstats_file;RSYSLOG_SyslogProtocol23Format

$RuleSet ciscoISE
$InputTCPServerStreamDriverMode 0
*.* ?ciscoISE_syslog;fixit

$RuleSet reflector
$InputTCPServerStreamDriverMode 0
*.* ?reflector_syslog;fixit

$RuleSet pan
$InputTCPServerStreamDriverMode 0
#*.* ?pan_syslog;fixit
*.* ~

$InputTCPServerBindRuleset CR_XnixSecLog_TCP_TLS_5090
$InputTCPServerRun 5090
$InputTCPServerBindRuleset checkpoint_fw
$InputTCPServerRun 5095
$InputTCPServerBindRuleset customapps
$InputTCPServerRun 5015
$InputTCPServerBindRuleset ironport
$InputTCPServerRun 5120
$InputUDPServerBindRuleset trend
$UDPServerRun 5100
$InputUDPServerBindRuleset netdev
$UDPServerRun 5035
$InputTCPServerBindRuleset snort
$InputTCPServerRun 5110
$InputTCPServerBindRuleset ciscoISE
$InputTCPServerRun 5130
$InputUDPServerBindRuleset reflector
$UDPServerRun 5130
$InputTCPServerBindRuleset pan
$InputTCPServerRun 5140

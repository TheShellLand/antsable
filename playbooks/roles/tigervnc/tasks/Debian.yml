---
- include_role:
    name: apt-installer
  vars:
    package: "{{ item }}"
  loop:
    - tigervnc-standalone-server
    - tigervnc-xorg-extension

- name: Ensure .vnc directory exists
  ansible.builtin.file:
    path: ~/.vnc
    state: directory
    mode: '0700'
  changed_when: false

- name: generate password file
  shell: | 
    mkdir -p ~/.vnc
    echo "{{ TIGERVNC_PASSWORD }}" | vncpasswd -f > ~/.vnc/passwd
    chmod 600 ~/.vnc/passwd
  changed_when: false
  failed_when: "TIGERVNC_PASSWORD | length == 0"

- include_role: name=reboot

- name: start vncserver
  shell: | 
    vncserver -kill :1 || ::
    vncserver :1
    vncconfig &
  changed_when: false

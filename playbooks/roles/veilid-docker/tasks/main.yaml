---
- include_tasks: "{{ansible_facts.os_family}}.yml"


- name: Git checkout https://github.com/TheShellLand/veilid-node-docker.git
  ansible.builtin.git:
    repo: 'https://github.com/TheShellLand/veilid-node-docker.git'
    dest: veilid-node-docker
    force: true
  changed_when: false

- name: when not x86_64
  block:
    - name: Git checkout https://github.com/TheShellLand/rust-docker.git
      ansible.builtin.git:
        repo: 'https://github.com/TheShellLand/rust-docker.git'
        dest: rust-docker
        force: true
      changed_when: false

    - name: build rust
      shell: |
        bash rust-docker/build.sh
      changed_when: false

    - name: build veilid
      shell: |
        bash veilid-node-docker/build.sh
      changed_when: false

  when: ansible_facts.architecture != "x86_64"


- name: when is x86_64
  block:
    - name: pull image
      shell: |
        docker pull ghcr.io/theshellland/veilid-node:latest
      changed_when: false

  when: ansible_facts.architecture == "x86_64"


- name: run server
  shell: |
    bash veilid-node-docker/veilid-server -f --password {VEILID_PASSWORD} --set-node-id {VEILID_NODE_ID} --network-key {VEILID_NETWORK_KEY}
    docker ps
  changed_when: false
  when: VEILID_PASSWORD and VEILID_NODE_ID and VEILID_NETWORK_KEY

- name: run server - VEILID_NETWORK_KEY
  shell: |
    bash veilid-node-docker/veilid-server -f --network-key {{VEILID_NETWORK_KEY}}
    docker ps
  changed_when: false
  when: VEILID_NETWORK_KEY

- name: run server
  shell: |
    bash veilid-node-docker/veilid-server
    docker ps
  changed_when: false
  when: not VEILID_PASSWORD and not VEILID_NODE_ID and not VEILID_NETWORK_KEY

- name: logs
  shell: |
    sleep 5
    bash veilid-node-docker/veilid-server-logs
  changed_when: false
